<!DOCTYPE html>
<html>
<head>
<title>Past transfers</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="color-scheme" content="dark light">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<script src="cards.js"></script>
<script src="listings.js"></script>
<script src="costs.js"></script>
<script>
allCardModels = allCardModels.data.allCardModels;

function listings(hits) {
  let priceFmt = new Intl.NumberFormat();

  let t = "cardFull;artist;scarcity;serial;priceETH;priceEUR;date<br>";

  for( const listing of hits ) {
    let priceETH = parseInt(listing.price, 16)/10**18;
    let priceEUR = priceETH * ethEurRate;

    let card = cardInfo(listing.cardModelId);
    let date = new Date(listing.date);

    let scarcity = card.scarcity.name;
    let artist = card.artist.displayName;

    t += card.slug + ";" + artist + ";" + scarcity + ";" + listing.serialNumber + ";"
       + priceFmt.format(priceETH) + ";" + priceFmt.format(priceEUR) + ";" + date.toLocaleString() + "<br>";
  }

  document.body.innerHTML = t;
};

function cardInfo(modelId) {
  return allCardModels.find(({ id }) => id == modelId);
}

// main
function main() {
  fetchEthPrice().then(json => {
    ethEurRate = parseInt(json.data.amount);
    var hits = [];
    fetchTransfers("serialNumber<=1000", "is_sale:true").then(json => {
      hits = hits.concat(json.hits);
      fetchTransfers("serialNumber>1000", "is_sale:true").then(json => {
        hits = hits.concat(json.hits);
        listings(hits);
      })
    })
  });
}

document.addEventListener('DOMContentLoaded', function() {
  main();
});

</script>
</head>
<body>
</body>
</html>
