<!DOCTYPE html>
<html>
<head>
<title>Histogram of owned cards</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="color-scheme" content="dark light">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<script src="users.js"></script>
<script src="listings.js"></script>
<script>
users = allUserIds.data.users;

var counters = {};
var processed = 0;
var whales = [];

async function sumCards(json, userId) {
  processed++;
  let q = json.hits.length;
  if( q>=50 ) {
    let whaleName = (await fetchUserNames([userId])).data.usersByIds[0].username;
    whales.push(whaleName + " -> " + q);
    console.log(whales);
  }
  if( q in counters )
    counters[q]++;
  else
    counters[q] = 1;
};

async function fetchRoster(userId) {
  return await fetch("https://js76hmpzh9-dsn.algolia.net/1/indexes/cards-date-desc/query", {
    "headers": {
      "accept": "*/*",
      "accept-language": "en-US;q=0.9,en;q=0.8",
      "content-type": "application/x-www-form-urlencoded",
      "sec-fetch-dest": "empty",
      "sec-fetch-mode": "cors",
      "sec-fetch-site": "cross-site",
      "x-algolia-api-key": "c7d162df9bb45f258af878219300d8c5",
      "x-algolia-application-id": "JS76HMPZH9"
    },
    "body": `{"query":"",
      "filters":"ownerUserId:${userId}",
      "page":0,
      "hitsPerPage":1000
    }`,
    "method": "POST",
    "mode": "cors",
    "credentials": "omit"
  }).then(response => {
    return response.json();
  });
}

// main
async function main() {
  let nbUsers = users.length;
  let block = 1;
  for( var u=0; u<nbUsers; u++ ) {
    let user = users[u];
    sumCards(await fetchRoster(user.id), user.id);
    document.body.innerHTML = "user processed: " + processed + "/" + nbUsers + " - users with > 50 cards: " + whales.length + "<br>"
                            + "total packs: " + JSON.stringify(counters);
  }
  document.body.innerHTML += "<br>" + whales;
}

document.addEventListener('DOMContentLoaded', function() {
  main();
});

</script>
</head>
<body>
</body>
</html>
