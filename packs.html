<!DOCTYPE html>
<html>
<head>
<title>Description des packs</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="color-scheme" content="dark light">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<link href="https://cdn.jsdelivr.net/npm/beercss@2.3.0/dist/cdn/beer.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/beercss@2.3.0/dist/cdn/beer.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@0.0.10/dist/cdn/material-dynamic-colors.min.js" type="text/javascript"></script>
<script src="js/cards.js?v=1"></script>
<script src="js/listings.js?v=1"></script>
<script>
var nbUsers = 24577;
var closedPacks = {"Santa Pack":979,"Launch Pack S1":1314,"Honey Base Pack":68,"Halloween Pack":463,"Wave Base Pack":167,"Dark Base Pack":98,"Starter Pack S1":177,"Kush Base Pack":84};
var usersWithPack = {"Santa Pack":481,"Launch Pack S1":871,"Honey Base Pack":68,"Halloween Pack":345,"Wave Base Pack":117,"Dark Base Pack":76,"Starter Pack S1":177,"Kush Base Pack":84};

allCardModels = allCardModels.data.allCardModels;

function cardInfo(s) {
  return allCardModels.find(({ slug }) => slug == s);
}

function showCards(cards, total) {
  let t = "<div class='cards'>";
  for( c of cards ) {
    quantity = c.quantity==null ? total/cards.length : c.quantity;
    perc = (100*quantity/total);
    t += "<div class='card'><a href='https://rules.art/card/" + c.cardModel.slug + "'><img src='" + c.cardModel.pictureUrl + "'></a><br>"
       + quantity + "<br>"
       + "<span class='perc'>" + (perc).toFixed(perc>0.1 ? 1 : 2) + "%</span>"
       + "</div>";
  }
  return t + "</div>";
}

// table creation and population
function createPack(img, summary, details) {
  return `
  <article>
    <details>
      <summary class="none">
        <div class="row">
          <img src="${img}">
          <div class="max">
            ${summary}
          <\/div>
          <i>arrow_drop_down<\/i>
        <\/div>
      <\/summary>
      <p>${details}<\/p>
    <\/details>
  <\/article>`;
}

function showPack(p) {
  let total = ((p.maxSupply != null ) ? p.maxSupply : p.supply) * p.cardsPerPack;
  let closed = closedPacks[p.displayName]!==undefined ? closedPacks[p.displayName] : -1;
  let userClosed = usersWithPack[p.displayName]!==undefined ? usersWithPack[p.displayName] : -1;

  let nbCommon = 0, nbPlatinium = 0;
  for( c of p.cardModels ) {
    quantity = c.quantity==null ? total/p.cardModels.length : c.quantity;
    info = cardInfo(c.cardModel.slug);
    if( info.scarcity.name == "Common" ) nbCommon += quantity;
    if( info.scarcity.name == "Platinium" ) nbPlatinium += quantity;
  }
  let percPlat = nbPlatinium>0 ? nbPlatinium/(nbPlatinium+nbCommon) : 0;

  let url = "https://rules.art/pack/" + p.slug;
  let t = "<a href='" + url + "'><h6>" + p.displayName + "</h6></a><br>"
        + (p.maxBuyableSupply != null ? p.maxBuyableSupply + " packs mis en vente, " : "")
        + p.availableQuantity + " par personne"
        + "<br>contient " + p.cardModelsCount + " cartes différentes"
        + (percPlat>0 ? ", " + (100*percPlat).toFixed(percPlat>0.05 ? 0 : 1) + "% de platine, " + (100*(1-(1-percPlat)**3)).toFixed(1) + "% de packs avec au moins une platine" : "")
        + "<br>distribué à " + p.supply + " exemplaires"
        + (closed>0 ? " dont " + closed + " toujours scellés (" + (100*closed/p.supply).toFixed(1) + "%)" : "")
        + (userClosed>0 && userClosed!=closed ? " détenus par " + userClosed + " personnes" : "");
  document.querySelector("#packs").innerHTML += createPack(p.pictureUrl, t, showCards(p.cardModels, total));
}

// main
async function main() {
  document.querySelector("#packs").innerHTML = "Loading...";
  let packs = (await fetchClassicPacks()).data.allClassicPacks.nodes;
  packs.push((await fetchLastStarterPack()).data.lastStarterPack);
  document.querySelector("#packs").innerHTML = "";
  for( p of packs ) showPack(p);
  document.querySelector("#update").innerHTML = "<i>query_stats</i>Statistiques tirées de " + nbUsers + " collectioneurs.";
}

function initDarkMode() {
  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    ui('mode', 'dark');
  }
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
    const newColorScheme = event.matches ? "dark" : "light";
    ui('mode', newColorScheme);
  });
}

document.addEventListener("DOMContentLoaded", function() {
  initDarkMode();
  main();
});

</script>
<style>
  nav {min-height: 48px !important;}
  #packs a:hover {text-decoration: underline;}
  .card {font-size: 12px; display: inline-block;}
  .card img {width: 48px;}
  .perc {color: #777;}
</style>
</head>
<body class="light">
<header class="primary responsive fixed medium-elevate">
  <nav>
    <a href="index.html"><button class="transparent circle"><i>home</i></button></a>
    <a href="offers.html" class="chip transparent"><i>shopping_cart</i>Offres</a>
    <a href="transfers.html" class="chip transparent"><i>receipt_long</i>Ventes</a>
    <a href="user.html" class="chip transparent"><i>person_search</i>Profils</a>
    <a href="fee.html" class="chip transparent"><i>currency_exchange</i>Frais</a>
    <a href="packs.html" class="chip fill"><i>view_carousel</i>Packs</a>
    <a href="fame.html" class="chip transparent"><i>workspace_premium</i>Hall of Fame</a>
    <div class="max"></div>
    <span id="update" class="chip primary-container"></span>
    <button class="transparent circle" onClick="ui('mode', ui('mode')=='dark'?'light':'dark')"><i>light_mode</i></button>
  </nav>
</header>
<main class="margin">
<div id="packs"></div>
</main>
</body>
</html>