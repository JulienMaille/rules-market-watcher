<!DOCTYPE html>
<html>
<head>
<title>Current offers</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="refresh" content="300" />
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<script src="cards.js"></script>
<script src="listings.js"></script>
<script src="costs.js"></script>
<script>
var recentDef = 30 * 60 * 1000; // recent is hard-coded to 30mins
var cheapNotif = 40;            // price threshold (EUR) for notification
var ethEurRate;

function listings(hits) {
  let searchParams = new URLSearchParams(window.location.search);

  function sortByPrice(a, b) { return a.price < b.price ? -1 : 1 }
  function sortByCard(a, b) { return a.cardModelId > b.cardModelId ? -1 : 1 }
  function sortByDate(a, b) { return a.date > b.date ? -1 : 1 }

  let sortRule = searchParams.has("sorting") ? searchParams.get("sorting") : "price";
  if( sortRule == "price" ) hits.sort(sortByPrice);
  if( sortRule == "card" ) hits.sort(sortByCard);
  if( sortRule == "date" ) hits.sort(sortByDate);
  //console.log(hits);

  for( const listing of hits ) {
    let priceETH = parseInt(listing.price, 16)/10**18;
    let priceEUR = (priceETH * ethEurRate).toFixed(0);
    let card = cardInfo(listing.cardModelId);
    let date = new Date(listing.date);
    let dateOptions = {year: "2-digit", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit"};
    let url = "https://rules.art/card/" + card.slug + "/" + listing.serialNumber;

    let cardIsPlat = card.slug.includes("platinium");
    let cardName = card.name.replace(/ Season .*/g, '');

    let recent = (new Date - date < recentDef);
    let classes = recent ? "recent" : "old";
    classes += card.tier==1 ? " toptier" : " lowtier";

    if( recent )
      if( (priceEUR<=2*cheapNotif && listing.serialNumber<=10)
        || (priceEUR<=cheapNotif && listing.serialNumber<=100)
        || (priceEUR<=1.5*cheapNotif && cardIsPlat) )
        notify(cardName + " #" + listing.serialNumber + ": " + priceEUR + "â‚¬", url, card.pictureUrl);

    let t = "<td id='card'><a href='" + url + "' target='_blank'>" + cardName + "</a></td>"
          + "<td id='serial'>" + listing.serialNumber + "</td>"
          + "<td id='price'>" + priceEUR + " â‚¬</td>"
          + "<td id='date'>" + date.toLocaleString([], dateOptions) + "</td>";
    insertInTable(t, cardIsPlat, listing.serialNumber, classes);
  }

  document.querySelector("#update").innerHTML = "refreshed at " + (new Date).toLocaleString() + " - " + hits.length + " <a href='transfers.html'>offers</a>";

  for( const [ key, value ] of searchParams ) {
    if( value=="false" ) document.querySelector("#"+key).click();
    if( key=="sorting" ) document.querySelector("#"+key).value=value;
  }
};

// table creation and population
function createTable(id, text) {
  document.querySelector("body").innerHTML += "" +
  `<table id="${id}" border=1>
           <thead>
             <tr>
               <th>Artist<\/th>
               <th>${text}<\/th>
               <th>Price<\/th>
               <th>Date<\/th>
            <\/tr>
           <\/thead>
           <tbody><\/tbody>
         <\/table>`;
}

function insertInTable(row, cardIsPlat, serialNumber, classes) {
  let tableId = "#tableHigh";
  if( cardIsPlat ) tableId = "#tablePlat";
  else if( serialNumber <= 10 ) tableId = "#tableLowTen";
  else if( serialNumber <= 100 ) tableId = "#tableLowHundred";
  else if( serialNumber <= 500 ) tableId = "#tableLowFiveHundred";
  else if( serialNumber <= 1000 ) tableId = "#tableLowThousand";
  else if( serialNumber <= 2000 ) tableId = "#tableLowTwoThousand";

  let roundClass = "notround";
  if( serialNumber.toPrecision(1)==serialNumber ) roundClass = "round";
  if( [69, 333, 420, 666, 667, 777].includes(serialNumber) ) roundClass = "round";

  const tableRef = document.querySelector(tableId);
  var newRow = tableRef.insertRow(tableRef.rows.length);
  newRow.className = roundClass + " " + classes;
  newRow.innerHTML = row;
}

function cardInfo(modelId) {
  return allCardModels.find(({ id }) => id == modelId);
}

// filtering and sorting
function setVisibility(className, visible) {
  elements = document.getElementsByClassName(className);
  for( var i = 0; i < elements.length; i++ )
    elements[i].style.display = visible ? 'table-row' : 'none';

  var queryParams = new URLSearchParams(window.location.search);
  queryParams.set(className, visible);
  history.replaceState(null, null, "?"+queryParams.toString());
}

function setSorting(value) {
  var queryParams = new URLSearchParams(window.location.search);
  queryParams.set("sorting", value);
  history.replaceState(null, null, "?"+queryParams.toString());
  location.reload();
}

// notifications
function registerNotifications() {
  navigator.serviceWorker.register('sw.js');
  if( !Notification )
    console.log('Browser does not support notifications.');
  else if( Notification.permission !== 'granted' )
    Notification.requestPermission();
}

function notify(content, link, picture) {
  Notification.requestPermission((result) => {
    if (result != 'granted') return;
    navigator.serviceWorker.ready.then((registration) => {
      registration.showNotification(content, {
        icon: picture,
        actions: [{action: "open_url", title: "Open"}]
      });
    });
  });
}

// main
document.addEventListener('DOMContentLoaded', function() {
  registerNotifications();

  createTable("tablePlat", "Plat");
  createTable("tableLowTen", "â‰¤10");
  createTable("tableLowHundred", "â‰¤100");
  createTable("tableLowFiveHundred", "â‰¤500");
  createTable("tableLowThousand", "â‰¤1000");
  createTable("tableLowTwoThousand", "â‰¤2000");
  createTable("tableHigh", "#");

  fetchEthPrice().then(json => {
    ethEurRate = parseInt(json.data.amount);
    var hits = [];
    fetchOffers("serialNumber<=2000").then(json => {
      hits = hits.concat(json.hits);
      fetchOffers("serialNumber>2000").then(json => {
        hits = hits.concat(json.hits);
        listings(hits);
      })
    })
  });

  fetchContractBuyingFee().then(json => {
    let feeEUR = parseInt(json.overall_fee)/10**18 * ethEurRate;
    let col = "ðŸŸ¢";
    if( feeEUR> 2.0 ) col = "ðŸ”¥";
    else if( feeEUR> 1.4 ) col = "ðŸ”´";
    else if( feeEUR> 0.7 ) col = "ðŸŸ¡";
    document.querySelector("#fee").innerHTML = col + "Current fee: " + feeEUR.toFixed(2) + "â‚¬ / Max: " + (1.5*feeEUR).toFixed(2) + "â‚¬";
  });
});

</script>
<style>
  body {background-color: black; color: #CCC; font-family: Roboto,Helvetica;}
  table {border-collapse: collapse; text-align: right; font-size: 14px; border: 1px #555 solid; float:left; margin-right: 14px;}
  a {color: #CCC; text-decoration: none;}
  a:hover {text-decoration: underline;}
  .recent #date {color: #FF0;}
  #card a {color: white;}
  #date {font-stretch: condensed; color: #777;}
  #tablePlat #card a, #tablePlat th {color: gold;}
  #tableLowTen #serial, #tableLowTen th {color: #9f04dc;}
  #tableLowHundred #serial, #tableLowHundred th {color: #03a9f4;}
  #tableLowFiveHundred #serial, #tableLowFiveHundred th {color: #ff9800;}
  #update {color: #777;}
  #options label, #options span {margin-right: 14px; float:left;}
  #options label {background: #05F;}
  #tablePlat {clear: both;}
</style>
</head>
<body>
<div id="options">
  <label for="old">show old listings
    <input type="checkbox" id="old" onchange="setVisibility('old', this.checked);" checked>
  </label>
  <label for="notround">show not round
    <input type="checkbox" id="notround" onchange="setVisibility('notround', this.checked);" checked>
  </label>
  <label for="lowtier">show lower tier (not finalists)
    <input type="checkbox" id="lowtier" onchange="setVisibility('lowtier', this.checked);" checked>
  </label>
  <span id="update"></span>
  <label for="sorting">Sort by:
    <select id="sorting" onChange="setSorting(this.value);">
        <option value="price">price</option>
        <option value="date">date</option>
        <option value="card">card</option>
    </select>
  </label>
  <span><a id="fee" href="fee.html"></a></span>
</div>
</body>
</html>
