<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="refresh" content="300" />
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<script type="text/javascript" src="cards.js"></script>
<script type="text/javascript" src="listings.js"></script>
<script type="text/javascript" src="costs.js"></script>
<script>
var recentDef = 30 * 60 * 1000; // recent is hard-coded to 30mins
var cheapNotif = 50;            // price threshold (EUR) for notification
var ethEurRate;

function listings(hits) {
  hits.sort(function(a, b) { return a.price < b.price ? -1 : 1 });
  //console.log(hits);
  for( const listing of hits ) {
    let priceETH = parseInt(listing.price, 16)/10**18;
    let priceEUR = (priceETH * ethEurRate).toFixed(0);
    let card = cardInfo(listing.cardModelId);
    let date = new Date(listing.date);
    let url = "https://rules.art/card/" + card.slug + "/" + listing.serialNumber;

    let cardIsPlat = card.slug.includes("platinium");
    let cardName = card.name.replace(/Season .*/g, '');

    let recent = (new Date - date < recentDef);
    let classes = recent ? "recent" : "old";
    classes += card.tier==1 ? " toptier" : " lowtier";

    if( recent )
      if( (priceEUR<=2*cheapNotif && listing.serialNumber<=10)
        || (priceEUR<=cheapNotif && listing.serialNumber<=100)
        || (priceEUR<=cheapNotif && cardIsPlat) )
        notify(cardName + " #" + listing.serialNumber + ": €" + priceEUR, url, card.pictureUrl);

    let t = "<td id='card'><a href='" + url + "' target='_blank'>" + cardName + "</a></td>"
          + "<td id='serial'>" + listing.serialNumber + "</td>"
          + "<td id='price'>" + priceEUR + " €</td>"
          + "<td id='date'>" + date.toLocaleString() + "</td>";
    insertInTable(t, cardIsPlat, listing.serialNumber, classes);
  }

  document.querySelector("#update").innerHTML = "updated at " + (new Date).toLocaleString() + " - " + hits.length + " listings";

  let searchParams = new URLSearchParams(window.location.search);
  for( const [ key, value ] of searchParams )
    if( value=="false" ) document.querySelector("#"+key).click();
};

function insertInTable(row, cardIsPlat, serialNumber, classes) {
  let tableId = "#tableHigh";
  if( cardIsPlat ) tableId = "#tablePlat";
  else if( serialNumber <= 10 ) tableId = "#tableLowTen";
  else if( serialNumber <= 100 ) tableId = "#tableLowHundred";
  else if( serialNumber <= 500 ) tableId = "#tableLowFiveHundred";

  let roundClass = "notround";
  if( serialNumber.toPrecision(1)==serialNumber ) roundClass = "round";
  if( [69, 333, 420, 666, 667, 777].includes(serialNumber) ) roundClass = "round";

  const tableRef = document.querySelector(tableId);
  var newRow = tableRef.insertRow(tableRef.rows.length);
  newRow.className = roundClass + " " + classes;
  newRow.innerHTML = row;
}

function cardInfo(modelId) {
  return allCardModels.find(({ id }) => id == modelId);
}

function setVisibility(className, visible) {
  elements = document.getElementsByClassName(className);
  for( var i = 0; i < elements.length; i++ )
    elements[i].style.display = visible ? 'table-row' : 'none';

  var queryParams = new URLSearchParams(window.location.search);
  queryParams.set(className, visible);
  history.replaceState(null, null, "?"+queryParams.toString());
}

document.addEventListener('DOMContentLoaded', function () {
  if( !Notification )
    console.log('Browser does not support notifications.');
  else if( Notification.permission !== 'granted' )
    Notification.requestPermission();
});

document.addEventListener('notificationclick', function(event) {
  switch(event.action){
    case 'open_url':
    clients.openWindow(event.notification.data.url); //which we got from above
    break;
  }
}, false);

function notify(content, link, picture) {
  var notification = new Notification(content, {
    icon: picture
  });
  notification.onclick = (event) => {
    event.preventDefault();
    window.open(link);
    notification.close();
  }
}

fetchEthPrice().then(json => {
  ethEurRate = parseInt(json.data.amount);
  var hits = [];
  fetchListings("serialNumber<=2000").then(json => {
    hits = hits.concat(json.hits);
    fetchListings("serialNumber>2000").then(json => {
      hits = hits.concat(json.hits);
      listings(hits);
    })
  })
});

fetchContractSellingFee().then(json => {
  let fee = parseInt(json.overall_fee)/10**18 * ethEurRate;
  document.querySelector("#fee").innerHTML = "Current fee: " + fee.toFixed(2) + "€"
                                           + " Max: " + (1.5*fee).toFixed(2) + "€";
});

</script>
<style>
  body {background-color: black; color: #CCC; font-family: Roboto,Helvetica;}
  table {border-collapse: collapse; text-align: right; font-size: 14px; border: 1px #555 solid; float:left; margin-right: 14px;}
  a {color: #CCC; text-decoration: none;}
  a:hover {text-decoration: underline;}
  label {background: #05F; margin-right: 14px;}
  .recent #date {color: #FF0;}
  #card a {color: white;}
  #tablePlat #card a, #tablePlat th {color: gold;}
  #tableLowTen #serial, #tableLowTen th {color: #9f04dc;}
  #tableLowHundred #serial, #tableLowHundred th {color: #03a9f4;}
  #tableLowFiveHundred #serial, #tableLowFiveHundred th {color: #ff9800;}
  #update {color: #777;}
</style>
</head>
<body>
<div>
  <label for="old">show old listings
    <input type="checkbox" id="old" onchange="setVisibility('old', this.checked);" checked></input>
  </label>
  <label for="notround">show not round
    <input type="checkbox" id="notround" onchange="setVisibility('notround', this.checked);" checked></input>
  </label>
  <label for="lowtier">show lower tier (not finalists)
    <input type="checkbox" id="lowtier" onchange="setVisibility('lowtier', this.checked);" checked></input>
  </label>
  <span id="update"></span>
  <a href="fee.html"><span id="fee"></span></a>
</div>
<table id="tablePlat" border=1>
  <thead>
    <tr>
      <th>Artist</th>
      <th>Plat</th>
      <th>Price</th>
      <th>Date</th>
   </tr>
  </thead>
  <tbody>
  </tbody>
</table>
<table id="tableLowTen" border=1>
  <thead>
    <tr>
      <th>Artist</th>
      <th>≤10</th>
      <th>Price</th>
      <th>Date</th>
   </tr>
  </thead>
  <tbody>
  </tbody>
</table>
<table id="tableLowHundred" border=1>
  <thead>
    <tr>
      <th>Artist</th>
      <th>≤100</th>
      <th>Price</th>
      <th>Date</th>
   </tr>
  </thead>
  <tbody>
  </tbody>
</table>
<table id="tableLowFiveHundred" border=1>
  <thead>
    <tr>
      <th>Artist</th>
      <th>≤500</th>
      <th>Price</th>
      <th>Date</th>
   </tr>
  </thead>
  <tbody>
  </tbody>
</table>
<table id="tableHigh" border=1>
  <thead>
    <tr>
      <th>Artist</th>
      <th>#</th>
      <th>Price</th>
      <th>Date</th>
   </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</body>
</html>
