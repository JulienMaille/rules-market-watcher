<!DOCTYPE html>
<html>
<head>
<title>Offres en cours</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="color-scheme" content="dark light">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<link href="https://cdn.jsdelivr.net/npm/beercss@2.3.0/dist/cdn/beer.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/beercss@2.3.0/dist/cdn/beer.min.js" type="text/javascript"></script>

<script src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@0.0.10/dist/cdn/material-dynamic-colors.min.js" type="text/javascript"></script>
<script src="js/cards.js?v=1"></script>
<script src="js/listings.js?v=1"></script>
<script src="js/costs.js?v=1"></script>
<script>
var recentDef = 30 * 60 * 1000; // recent is hard-coded to 30mins
var cheapNotif = 40;            // price threshold (EUR) for notification
var timeoutNotif = null;
allCardModels = allCardModels.data.allCardModels;

function listings(hits, notify, ethEurRate) {
  let dateOptions = {year: "2-digit", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit"};
  let timeOptions = {hour: "2-digit", minute: "2-digit"};
  let euroOptions = {style: "currency", currency: "EUR", maximumFractionDigits: 0};
  let euroFmt = new Intl.NumberFormat([], euroOptions);

  for( listing of hits )
    listing.cardInfo = cardInfo(listing.cardModelId);

  let sortRule = document.querySelector("#sorting").value;
  if( sortRule == "price" ) hits.sort(sortByPrice);
  if( sortRule == "date" ) hits.sort(sortByDate);
  if( sortRule == "serial" ) hits.sort(sortBySerial);
  if( sortRule == "cardprice" ) hits.sort(sortByCardPrice);
  if( sortRule == "cardserial" ) hits.sort(sortByCardSerial);
  //console.log(hits);

  let sum = 0;
  for( const listing of hits ) {
    let card = listing.cardInfo;
    let date = new Date(listing.date);

    let priceETH = parseInt(listing.price, 16)/10**18;
    let priceEUR = priceETH * ethEurRate;
    sum += priceETH * ethEurRate;
    let url = "https://rules.art/card/" + card.slug + "/" + listing.serialNumber;

    let cardIsCommon = card.scarcity.name == "Common";
    let cardIsPlat = card.scarcity.name == "Platinium";
    let artist = card.artist.displayName;

    let promo = false;//listing.sellerUserId == "62ab894c838a77a225fabf12"
    let recent = (new Date - date < recentDef)
    let lessRecent = (new Date - date < recentDef*6) || promo;
    let classes = recent ? "recent" : lessRecent ? "lessRecent" : "old";
    classes += topTier.includes(card.artist.slug) ? " toptier" : " lowtier";

    if( recent && listing.available &&
      ((priceEUR<=2*cheapNotif && listing.serialNumber<=10)
        || (priceEUR<=cheapNotif && listing.serialNumber<=100)
        || (priceEUR<=1.5*cheapNotif && cardIsPlat)) ) {
      if( notify ) sendNotification(artist + " #" + listing.serialNumber + " " + card.scarcity.name + ": " + priceEUR.toFixed(2) + "‚Ç¨", card.pictureUrl);
    }

    let dateText = "";
    if( listing.available )
      dateText = date.toLocaleString([], dateOptions).replace(' ', '<br>');
    else
      dateText = "Transfer " + date.toLocaleTimeString([], timeOptions);
    let dateClass = recent || lessRecent ? "error-container grey-text" : "grey-text";
    let sellerOnClick = `class="${dateClass} ID${listing.sellerStarknetAddress}" onClick="fetchUser(this, '${listing.sellerStarknetAddress}'); return false;"`;

    let t = "<td id='card'><a href='" + url + "' target='_blank'>" + artist + "</a></td>"
          + "<td id='serial'>" + listing.serialNumber + "</td>"
          + "<td id='price'>" + euroFmt.format(priceEUR) + "</td>"
          + "<td id='date'" + sellerOnClick + ">" + dateText + "</td>";
    insertInTable(t, cardIsCommon, card.scarcity.name, listing.serialNumber, classes);
  }

  let update = hits.length + " offres le " + (new Date).toLocaleString([], dateOptions)
             + " üí± Total : " + euroFmt.format(sum);
  document.querySelector("#update").innerHTML = update;
};

// table creation and population
function createTable(id, text) {
  return `
  <table id="${id}" class="s6 m4 l2 border tiny-space">
    <thead>
      <tr>
        <th colspan=4>${text}<\/th>
     <\/tr>
    <\/thead>
    <tbody><\/tbody>
  <\/table>`;
}

function insertInTable(row, cardIsCommon, scarcity, serialNumber, classes) {
  let tableId = "#tableHigh";
  if( !cardIsCommon ) tableId = "#table" + scarcity;
  else if( serialNumber <= 10 ) tableId = "#tableLowTen";
  else if( serialNumber <= 100 ) tableId = "#tableLowHundred";
  else if( serialNumber <= 500 ) tableId = "#tableLowFiveHundred";
  else if( serialNumber <= 1000 ) tableId = "#tableLowThousand";
  else if( serialNumber <= 2000 ) tableId = "#tableLowTwoThousand";

  let roundClass = "notround";
  if( serialNumber.toPrecision(1)==serialNumber ) roundClass = "isround";
  if( [69, 333, 420, 666, 667, 777].includes(serialNumber) ) roundClass = "isround";

  const tableRef = document.querySelector(tableId + " tbody");
  var newRow = tableRef.insertRow(tableRef.rows.length);
  newRow.className = roundClass + " " + classes;
  newRow.innerHTML = row;
}

function cardInfo(modelId) {
  return allCardModels.find(({ id }) => id == modelId);
}

// filtering and sorting
function setVisibility(className, visible) {
  elements = document.getElementsByClassName(className);
  for( var i = 0; i < elements.length; i++ )
    elements[i].style.display = visible ? "none" : "table-row";

  var searchParams = new URLSearchParams(window.location.search);
  searchParams.set(className, visible);
  history.replaceState(null, null, "?"+searchParams.toString());

  hideEmptyTables();
}

function setAllSerials(b) {
  var searchParams = new URLSearchParams(window.location.search);
  searchParams.set('allserials', b);
  history.replaceState(null, null, "?"+searchParams.toString());
  main();
}

function hideEmptyTables() {
  // Show all tables
  let tables = document.querySelectorAll('#tables table');
  for( const t of tables ) t.style.display = "table";

  // hide empty tables based on tbody height
  for( const t of tables ) {
    if( t.querySelector('tbody').getBoundingClientRect().height == 0 )
      t.style.display = "none";
  }
}

function setSorting(value) {
  var searchParams = new URLSearchParams(window.location.search);
  searchParams.set("sorting", value);
  history.replaceState(null, null, "?"+searchParams.toString());
  main();
}

function toggleNotify() {
  var searchParams = new URLSearchParams(window.location.search);
  let notify = searchParams.get("notify") == "true";
  searchParams.set("notify", !notify);
  history.replaceState(null, null, "?"+searchParams.toString());
  main();
}

// notifications
function registerNotifications() {
  navigator.serviceWorker.register("sw.js");
  if( !Notification )
    console.log("Browser does not support notifications.");
  else if( Notification.permission !== "granted" )
    Notification.requestPermission();
}

function sendNotification(content, picture) {
  Notification.requestPermission((result) => {
    if( result != "granted" ) return;
    navigator.serviceWorker.ready.then((registration) => {
      registration.showNotification(content, {icon: picture});
    });
  });
}

function fetchUser(clickedDom, userAddresses) {
  clickedDom.innerHTML = "Loading...";
  fetchUserNames([userAddresses]).then(json => {
    for( const user of json.data.usersByStarknetAddresses ) {
      let userClass = ".ID" + userAddresses;
      document.querySelectorAll(userClass).forEach(function(td) {
        td.removeAttribute("onclick");
        let url = "https://rules.art/user/" + user.slug + "/cards";
        td.innerHTML = "<a href='user.html?user=" + user.slug + "'>" + user.username + "</a>"
                     + " <a href='" + url + "' target='_blank'><img class='responsive' src='img/rules-logo.png'></a>";
      });
    }
  });
}

// main
async function main() {
  let tables = {
    tableHalloween: "Hall<span class='emoji'>üéÉ</span>ween",
    tablePlatinium: "Platine",
    tableLowTen: "inf√©rieur √† 10",
    tableLowHundred: "inf√©rieur √† 100",
    tableLowFiveHundred: "inf√©rieur √† 500",
    tableLowThousand: "inf√©rieur √† 1000",
    tableLowTwoThousand: "inf√©rieur √† 2000",
    tableHigh: "sup√©rieur √† 2000"
  };

  let t = "";
  for( const key in tables )
    t += createTable(key, tables[key]);
  document.querySelector("#tables").innerHTML = t;

  let searchParams = new URLSearchParams(window.location.search);
  let notify = false;
  let allSerials = false;
  let hiddenClass = [];
  for( const [key, value] of searchParams ) {
    if( value=="true" ) {
      document.querySelector("#"+key).checked = true;
      hiddenClass.push(key);
    }
    if( key=="sorting" ) document.querySelector("#"+key).value = value;
    if( key=="notify" ) notify = value=="true";
    if( key=="allserials" ) allSerials = value=="true";
  }

  document.querySelector("#notify").innerHTML = notify ? "üîî" : "üîï";

  let ethEurRate = parseFloat((await fetchEthPrice()).data.amount);
  let hits = [];
  let blocks = allSerials ? [0,500,1500,2500] : [0,300,1000];
  for( var i=0; i<blocks.length-1; i++ ) {
    var delta = hits.length;
    hits = hits.concat((await fetchOffers("serialNumber>"+blocks[i]+" AND serialNumber<="+blocks[i+1], "price:-0000000000000000000000")).hits);
    delta = hits.length-delta;
    if( delta>=1000 ) window.alert("Missing results");
    console.log(delta);
    document.querySelector("#update").innerHTML = "<progress max='3000' value='"+blocks[i]+"'></progress>";
  }
  if( allSerials )
    hits = hits.concat((await fetchOffers("serialNumber>"+blocks[blocks.length-1], "price:-0000000000000000000000")).hits);
  listings(hits, notify, ethEurRate);

  for( const key of hiddenClass )
    setVisibility(key, true);
  if( hiddenClass.length==0 ) hideEmptyTables();

  let gasPrice = parseInt((await fetchGasPrice()).gas_price, 16)/10**18;
  let feeETH = gasPrice*buyGasUsage;
  let feeEUR = feeETH*ethEurRate;

  document.querySelector("#feeicon").innerHTML = iconCost(feeEUR);
  document.querySelector("#feelink").innerHTML = "Frais : " + feeEUR.toFixed(2) + "‚Ç¨ / Max: " + (1.5*feeEUR).toFixed(2) + "‚Ç¨";

  if( timeoutNotif!=null ) clearTimeout(timeoutNotif);
  timeoutNotif = setTimeout(() => {main();}, 5*60*1000); // refresh in 5 mins
}

document.addEventListener("DOMContentLoaded", function() {
  registerNotifications();
  main();
});

</script>
<style>
  nav {min-height: 48px !important;}
  #tables table {text-align: right; align-self: flex-start;}
  #tables a:hover {text-decoration: underline;}
  #tables th {text-align: center;}
  #date {cursor: help; font-size: 11px; padding-bottom: 2px; padding-top: 2px;}
  .emoji {font-size: 10pt; }
  #tableHalloween #card a, #tableHalloween th {color: #ff9800;}
  #tablePlatinium #card a, #tablePlatinium th {color: #ccad00;}
  #tableLowTen #serial, #tableLowTen th {color: #cf5ffc;}
  #tableLowHundred #serial, #tableLowHundred th {color: #03a9f4;}
  #tableLowFiveHundred #serial, #tableLowFiveHundred th {color: #4caf50;}
  #tableHalloween {background-color: #ff980010;}
  #tablePlatinium {background-color: #ccad0010;}
  #tableLowTen {background-color: #cf5ffc10;}
  #tableLowHundred {background-color: #03a9f410;}
  #tableLowFiveHundred {background-color: #4caf5020;}
  #tableLowThousand {background-color: #88888820;}

  #feeicon {animation: scaleIn .8s infinite linear;}
  @keyframes scaleIn {
    from {opacity: 1; transform: scale(.75, .75);}
    to {opacity: 0; transform: scale(1.75, 1.75);}
  }
</style>
</head>
<body class="light">
<header class="primary responsive fixed medium-elevate">
  <nav class="no-space">
    <a href="index.html"><button class="transparent circle"><i>home</i></button></a>
    <a href="offers.html" class="chip transparent">üõí Offres</a>
    <a href="transfers.html" class="chip transparent">üßæ Ventes</a>
    <a href="user.html" class="chip transparent">ü§ë Profils</a>
    <a href="fee.html" class="chip transparent">üí∏ Fee</a>
    <a href="packs.html" class="chip transparent">üÉè Packs</a>
    <a href="fame.html" class="chip transparent">üèÖ Hall of Fame</a>
    <div class="max"></div>
    <span id="update"></span>
    <button class="transparent circle" onClick="ui('mode', ui('mode')=='dark'?'light':'dark')"><i>light_mode</i></button>
  </nav>
</header>
<main>
<div id="options" class="field small small-margin">
  <nav>
    <label class="checkbox">
      <input type="checkbox" id="old" onchange="setVisibility('old', this.checked);">
      <span>r√©cent</span>
    </label>
    <label class="checkbox">
      <input type="checkbox" id="lowtier" onchange="setVisibility('notround', this.checked);">
      <span>chiffres ronds</span>
    </label>
    <label class="checkbox">
      <input type="checkbox" id="lowtier" onchange="setVisibility('lowtier', this.checked);">
      <span>>top tier</span>
    </label>
    <label class="checkbox">
      <input type="checkbox" id="allserials" onchange="setAllSerials(this.checked);">
      <span>+1000</span>
    </label>
    <div class="field label suffix border small">
      <select class="form-select" id="sorting" onChange="setSorting(this.value);">
        <option value="price">prix</option>
        <option value="date">date</option>
        <option value="serial">serial</option>
        <option value="cardprice">carte/prix</option>
        <option value="cardserial">carte/serial</option>
      </select>
      <label class="active">Tri</label>
      <i>arrow_drop_down</i>
    </div>
    <div class="chip circle transparent" id="notify" onClick="toggleNotify()"></div>
    <div class="form-label"><span id="feeicon"></span><a id="feelink" href="fee.html"></a></div>
  </nav>
</div>
<div class="grid no-space" id="tables"></div>
</main>
</body>
</html>
